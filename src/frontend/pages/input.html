<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½•å…¥ - è¨€è‘‰AI</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #fdf2f8 0%, #e0f2fe 100%);
        }
        .batch-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex-1">
                <a href="../index.html" class="btn btn-ghost text-xl">
                    <span class="text-2xl">ğŸŒ¸</span>
                    <span class="font-bold">è¨€è‘‰AI</span>
                </a>
            </div>
            <div class="flex-none">
                <a href="../index.html" class="btn btn-ghost btn-sm">â† è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="flex justify-center mb-8">
            <ul class="steps">
                <li class="step step-primary">ç²˜è´´æ•°æ®</li>
                <li class="step" id="step2">é¢„è§ˆç¡®è®¤</li>
                <li class="step" id="step3">å®Œæˆå…¥åº“</li>
            </ul>
        </div>

        <!-- å½•å…¥è¡¨å• -->
        <div class="max-w-3xl mx-auto">
            <div class="card bg-white shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-2">ğŸ“ å½•å…¥æ—¥è¯­å­¦ä¹ å†…å®¹</h2>
                    <p class="text-gray-500 mb-6">æ”¯æŒå•æ¡å½•å…¥æˆ–æ‰¹é‡å½•å…¥ï¼ˆJSONæ•°ç»„ï¼‰</p>
                    
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text font-bold">AIè¯†åˆ«ç»“æœ (JSONæ ¼å¼)</span>
                            <span class="label-text-alt text-primary batch-indicator" id="batchIndicator" style="display: none;">
                                ğŸ“¦ æ£€æµ‹åˆ°æ‰¹é‡æ•°æ®
                            </span>
                        </label>
                        <textarea 
                            id="jsonInput" 
                            class="textarea textarea-bordered h-80 font-mono text-sm"
                            placeholder='åœ¨æ­¤ç²˜è´´JSONæ•°æ®ï¼Œæ”¯æŒå•æ¡æˆ–æ•°ç»„æ ¼å¼ï¼š

å•æ¡ç¤ºä¾‹ï¼š
{
  "content_type": "sentence",
  "original_jp": "ç§ã¯å­¦ç”Ÿã§ã™",
  "hiragana": "ã‚ãŸã—ã¯ãŒãã›ã„ã§ã™",
  "romaji": "watashi wa gakusei desu",
  "chinese_meaning": "æˆ‘æ˜¯å­¦ç”Ÿ"
}

æ‰¹é‡ç¤ºä¾‹ï¼ˆJSONæ•°ç»„ï¼‰ï¼š
[
  {
    "content_type": "sentence",
    "original_jp": "ã§ã‚“ã—ã‚ƒã¯ã‚‚ã†ã™ãæ¥ã¾ã™ã‹",
    "hiragana": "ã§ã‚“ã—ã‚ƒã¯ã‚‚ã†ã™ããã¾ã™ã‹",
    "chinese_meaning": "ç«è½¦å¾ˆå¿«å°±ä¼šæ¥å—ï¼Ÿ"
  },
  {
    "content_type": "sentence",
    "original_jp": "æ±äº¬é§…ã¯çµ‚ç‚¹ã§ã™ã‹ã€‚",
    "hiragana": "ã¨ã†ãã‚‡ã†ãˆãã¯ã—ã‚…ã†ã¦ã‚“ã§ã™ã‹ã€‚",
    "chinese_meaning": "ä¸œäº¬ç«™æ˜¯ç»ˆç‚¹ç«™å—ï¼Ÿ"
  }
]'
                        ></textarea>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex gap-4 justify-end">
                        <button class="btn btn-ghost" onclick="clearInput()">
                            ğŸ—‘ï¸ æ¸…ç©º
                        </button>
                        <button class="btn btn-outline" onclick="loadExample('single')">
                            ğŸ“‹ å•æ¡ç¤ºä¾‹
                        </button>
                        <button class="btn btn-outline btn-secondary" onclick="loadExample('batch')">
                            ğŸ“¦ æ‰¹é‡ç¤ºä¾‹
                        </button>
                        <button class="btn btn-primary" onclick="startSegmentation()">
                            å¼€å§‹åˆ†æ‹£ â–¶ï¸
                        </button>
                    </div>

                    <!-- æç¤ºä¿¡æ¯ -->
                    <div class="alert alert-info mt-6">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div>
                            <h3 class="font-bold">ä½¿ç”¨è¯´æ˜</h3>
                            <div class="text-sm">
                                1. æ”¯æŒå•æ¡JSONæˆ–JSONæ•°ç»„æ ¼å¼<br>
                                2. æ‰¹é‡å½•å…¥æ—¶è¯·ä½¿ç”¨JSONæ•°ç»„æ ¼å¼ï¼ˆæ–¹æ‹¬å·åŒ…è£¹ï¼‰<br>
                                3. ç‚¹å‡»"å¼€å§‹åˆ†æ‹£"åä¼šæ˜¾ç¤ºæ‰€æœ‰æ•°æ®çš„é¢„è§ˆ<br>
                                4. ç¡®è®¤æ— è¯¯åç‚¹å‡»"ç¡®è®¤å…¥åº“"å³å¯æ‰¹é‡ä¿å­˜
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œæ£€æµ‹æ˜¯å¦ä¸ºæ‰¹é‡æ•°æ®
        document.getElementById('jsonInput').addEventListener('input', function() {
            const value = this.value.trim();
            const indicator = document.getElementById('batchIndicator');
            
            if (value.startsWith('[')) {
                indicator.style.display = 'inline';
            } else {
                indicator.style.display = 'none';
            }
        });

        // åŠ è½½ç¤ºä¾‹
        function loadExample(type) {
            let example;
            
            if (type === 'single') {
                example = {
                    "content_type": "sentence",
                    "original_jp": "ç§ã¯å­¦ç”Ÿã§ã™",
                    "hiragana": "ã‚ãŸã—ã¯ãŒãã›ã„ã§ã™",
                    "romaji": "watashi wa gakusei desu",
                    "chinese_meaning": "æˆ‘æ˜¯å­¦ç”Ÿ",
                    "source": "duolingo_20260211_001.png",
                    "tags": {
                        "grammar_points": ["ã¯ä¸»é¢˜åŠ©è¯", "ã§ã™ç¤¼è²Œä½“"],
                        "difficulty": 1
                    }
                };
            } else {
                // æ‰¹é‡ç¤ºä¾‹
                example = [
                    {
                        "content_type": "sentence",
                        "original_jp": "ã§ã‚“ã—ã‚ƒã¯ã‚‚ã†ã™ãæ¥ã¾ã™ã‹",
                        "hiragana": "ã§ã‚“ã—ã‚ƒã¯ã‚‚ã†ã™ããã¾ã™ã‹",
                        "romaji": "densha wa mousugu kimasu ka",
                        "chinese_meaning": "ç«è½¦å¾ˆå¿«å°±ä¼šæ¥å—ï¼Ÿ",
                        "tags": {
                            "grammar_points": ["ã¯ï¼ˆä¸»é¢˜æ ‡è®°ï¼‰", "ã‚‚ã†ã™ãï¼ˆæ—¶é—´å‰¯è¯ï¼‰", "ã¾ã™ï¼ˆæ•¬ä½“ï¼‰", "ã‹ï¼ˆç–‘é—®åŠ©è¯ï¼‰"],
                            "scene": "äº¤é€š/è¯¢é—®",
                            "difficulty": 1
                        }
                    },
                    {
                        "content_type": "sentence",
                        "original_jp": "æ±äº¬é§…ã¯çµ‚ç‚¹ã§ã™ã‹ã€‚",
                        "hiragana": "ã¨ã†ãã‚‡ã†ãˆãã¯ã—ã‚…ã†ã¦ã‚“ã§ã™ã‹ã€‚",
                        "romaji": "toukyou eki wa shuuten desu ka",
                        "chinese_meaning": "ä¸œäº¬ç«™æ˜¯ç»ˆç‚¹ç«™å—ï¼Ÿ",
                        "tags": {
                            "grammar_points": ["ã¯ï¼ˆä¸»é¢˜æ ‡è®°ï¼‰", "ã§ã™ï¼ˆåˆ¤æ–­åŠ©åŠ¨è¯ï¼‰", "ã‹ï¼ˆç–‘é—®åŠ©è¯ï¼‰"],
                            "scene": "äº¤é€š/è½¦ç«™",
                            "difficulty": 1
                        }
                    },
                    {
                        "content_type": "sentence",
                        "original_jp": "äºŒååˆ†ãã‚‰ã„ã‹ã‹ã‚Šã¾ã™ã€‚",
                        "hiragana": "ã«ã˜ã‚…ã£ã·ã‚“ãã‚‰ã„ã‹ã‹ã‚Šã¾ã™ã€‚",
                        "romaji": "nijuppun gurai kakarimasu",
                        "chinese_meaning": "å¤§æ¦‚è¦èŠ±äºŒååˆ†é’Ÿã€‚",
                        "tags": {
                            "grammar_points": ["ãã‚‰ã„ï¼ˆå¤§è‡´æ•°é‡ï¼‰", "ã‹ã‹ã‚Šã¾ã™ï¼ˆèŠ±è´¹æ—¶é—´ï¼‰", "ã¾ã™ï¼ˆæ•¬ä½“ï¼‰"],
                            "scene": "æ—¶é—´/æ•°é‡",
                            "difficulty": 1
                        }
                    }
                ];
            }
            
            document.getElementById('jsonInput').value = JSON.stringify(example, null, 2);
            
            // æ›´æ–°æ‰¹é‡æŒ‡ç¤ºå™¨
            const indicator = document.getElementById('batchIndicator');
            if (type === 'batch') {
                indicator.style.display = 'inline';
            } else {
                indicator.style.display = 'none';
            }
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('batchIndicator').style.display = 'none';
        }

        // å¼€å§‹åˆ†æ‹£
        async function startSegmentation() {
            const jsonInput = document.getElementById('jsonInput').value;
            
            if (!jsonInput.trim()) {
                alert('è¯·å…ˆç²˜è´´JSONæ•°æ®');
                return;
            }

            let data;
            try {
                data = JSON.parse(jsonInput);
            } catch (e) {
                alert('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥\né”™è¯¯ä¿¡æ¯: ' + e.message);
                return;
            }

            // å¦‚æœæ˜¯å•æ¡ï¼Œè½¬æ¢ä¸ºæ•°ç»„
            const isBatch = Array.isArray(data);
            const entries = isBatch ? data : [data];

            // éªŒè¯å¿…å¡«å­—æ®µ
            const required = ['original_jp', 'hiragana', 'chinese_meaning'];
            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                for (const field of required) {
                    if (!entry[field]) {
                        alert(`ç¬¬${i + 1}æ¡æ•°æ®ç¼ºå°‘å¿…å¡«å­—æ®µ: ${field}`);
                        return;
                    }
                }
            }

            try {
                const response = await fetch('/api/entries/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)  // å‘é€åŸå§‹æ•°æ®ï¼ˆå•æ¡æˆ–æ•°ç»„ï¼‰
                });

                const result = await response.json();

                if (result.success) {
                    // ä¿å­˜é¢„è§ˆæ•°æ®åˆ°sessionStorage
                    sessionStorage.setItem('previewData', JSON.stringify(result.data));
                    // è·³è½¬åˆ°é¢„è§ˆé¡µé¢
                    window.location.href = 'preview.html';
                } else {
                    alert('é¢„è§ˆç”Ÿæˆå¤±è´¥: ' + (result.error?.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
    </script>
</body>
</html>
