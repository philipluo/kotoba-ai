<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å½•å…¥ - è¨€è‘‰AI</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.0/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #fdf2f8 0%, #e0f2fe 100%);
        }
        .batch-indicator {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex-1">
                <a href="../index.html" class="btn btn-ghost text-xl">
                    <span class="text-2xl">ğŸŒ¸</span>
                    <span class="font-bold">è¨€è‘‰AI</span>
                </a>
            </div>
            <div class="flex-none">
                <a href="../index.html" class="btn btn-ghost btn-sm">â† è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
        <div class="flex justify-center mb-8">
            <ul class="steps">
                <li class="step step-primary">ç²˜è´´æ•°æ®</li>
                <li class="step" id="step2">é¢„è§ˆç¡®è®¤</li>
                <li class="step" id="step3">å®Œæˆå…¥åº“</li>
            </ul>
        </div>

        <!-- å½•å…¥è¡¨å• -->
        <div class="max-w-3xl mx-auto">
            <div class="card bg-white shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-2">ğŸ“ å½•å…¥æ—¥è¯­å­¦ä¹ å†…å®¹</h2>
                    <p class="text-gray-500 mb-6">æ”¯æŒå•æ¡å½•å…¥æˆ–æ‰¹é‡å½•å…¥ï¼ˆJSONæ•°ç»„ï¼‰</p>
                    
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text font-bold">AIè¯†åˆ«ç»“æœ (JSONæ ¼å¼)</span>
                            <span class="label-text-alt text-primary batch-indicator" id="batchIndicator" style="display: none;">
                                ğŸ“¦ æ£€æµ‹åˆ°æ‰¹é‡æ•°æ®
                            </span>
                        </label>
                        <textarea 
                            id="jsonInput" 
                            class="textarea textarea-bordered h-80 font-mono text-sm"
                            placeholder='åœ¨æ­¤ç²˜è´´JSONæ•°æ®ï¼Œã€é‡è¦ã€‘å¿…é¡»åŒ…å«AIé¢„åˆ†è¯ï¼š

å•æ¡ç¤ºä¾‹ï¼ˆå«åˆ†è¯ï¼‰ï¼š
{
  "content_type": "sentence",
  "original_jp": "ç§ã¯å­¦ç”Ÿã§ã™",
  "hiragana": "ã‚ãŸã—ã¯ãŒãã›ã„ã§ã™",
  "chinese_meaning": "æˆ‘æ˜¯å­¦ç”Ÿ",
  "segmented_words": [
    {"word_jp": "ç§", "hiragana": "ã‚ãŸã—", "word_type": "pronoun", "position": 0},
    {"word_jp": "ã¯", "hiragana": "ã¯", "word_type": "particle", "position": 1},
    {"word_jp": "å­¦ç”Ÿ", "hiragana": "ãŒãã›ã„", "word_type": "noun", "position": 2},
    {"word_jp": "ã§ã™", "hiragana": "ã§ã™", "word_type": "aux_verb", "position": 3}
  ]
}

âš ï¸ æç¤ºï¼šå¤åˆ¶"æç¤ºè¯­æ¨¡æ¿"è®©AIå¸®ä½ ç”Ÿæˆå¸¦åˆ†è¯çš„JSONï¼
æ–‡æ¡£ï¼šdocs/08-JSONå½•å…¥æ¨¡æ¿.md'
                        ></textarea>
                    </div>

                    <!-- æ“ä½œæŒ‰é’® -->
                    <div class="flex gap-4 justify-end">
                        <button class="btn btn-ghost" onclick="clearInput()">
                            ğŸ—‘ï¸ æ¸…ç©º
                        </button>
                        <button class="btn btn-outline" onclick="loadExample('single')">
                            ğŸ“‹ å•æ¡ç¤ºä¾‹
                        </button>
                        <button class="btn btn-outline btn-secondary" onclick="loadExample('batch')">
                            ğŸ“¦ æ‰¹é‡ç¤ºä¾‹
                        </button>
                        <button class="btn btn-primary" onclick="startSegmentation()">
                            å¼€å§‹åˆ†æ‹£ â–¶ï¸
                        </button>
                    </div>

                    <!-- æç¤ºä¿¡æ¯ -->
                    <div class="alert alert-warning mt-6">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                        <div>
                            <h3 class="font-bold">âš ï¸ é‡è¦æç¤ºï¼šå¿…é¡»ä½¿ç”¨AIé¢„åˆ†è¯</h3>
                            <div class="text-sm">
                                1. ç¨‹åºè‡ªåŠ¨åˆ†è¯<strong>ä¸å‡†ç¡®</strong>ï¼Œè¯·åŠ¡å¿…ä½¿ç”¨AIé¢„åˆ†è¯<br>
                                2. JSONä¸­å¿…é¡»åŒ…å« <code>segmented_words</code> æ•°ç»„<br>
                                3. å‚è€ƒæ–‡æ¡£ï¼šdocs/08-JSONå½•å…¥æ¨¡æ¿.md è·å–æç¤ºè¯­æ¨¡æ¿<br>
                                4. æ²¡æœ‰åˆ†è¯çš„æ•°æ®å°†ä½¿ç”¨ä¸å‡†ç¡®çš„è‡ªåŠ¨åˆ†è¯ï¼ˆä¸æ¨èï¼‰
                            </div>
                        </div>
                    </div>
                    
                    <!-- æç¤ºä¿¡æ¯ -->
                    <div class="alert alert-info mt-4">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <div>
                            <h3 class="font-bold">ä½¿ç”¨æµç¨‹</h3>
                            <div class="text-sm">
                                1. å‘é€æˆªå›¾ç»™AI + æç¤ºè¯­æ¨¡æ¿<br>
                                2. AIè¿”å›å¸¦åˆ†è¯çš„JSONï¼ˆå« segmented_wordsï¼‰<br>
                                3. å¤åˆ¶JSONç²˜è´´åˆ°è¿™é‡Œ<br>
                                4. ç‚¹å‡»"å¼€å§‹åˆ†æ‹£"é¢„è§ˆ â†’ ç¡®è®¤å…¥åº“
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ç›‘å¬è¾“å…¥å˜åŒ–ï¼Œæ£€æµ‹æ˜¯å¦ä¸ºæ‰¹é‡æ•°æ®
        document.getElementById('jsonInput').addEventListener('input', function() {
            const value = this.value.trim();
            const indicator = document.getElementById('batchIndicator');
            
            if (value.startsWith('[')) {
                indicator.style.display = 'inline';
            } else {
                indicator.style.display = 'none';
            }
        });

        // åŠ è½½ç¤ºä¾‹
        function loadExample(type) {
            let example;
            
            if (type === 'single') {
                example = {
                    "content_type": "sentence",
                    "original_jp": "ç§ã¯å­¦ç”Ÿã§ã™",
                    "hiragana": "ã‚ãŸã—ã¯ãŒãã›ã„ã§ã™",
                    "romaji": "watashi wa gakusei desu",
                    "chinese_meaning": "æˆ‘æ˜¯å­¦ç”Ÿ",
                    "source": "duolingo_20260211_001.png",
                    "tags": {
                        "grammar_points": ["ã¯ä¸»é¢˜åŠ©è¯", "ã§ã™ç¤¼è²Œä½“"],
                        "difficulty": 1
                    },
                    "segmented_words": [
                        {
                            "word_jp": "ç§",
                            "hiragana": "ã‚ãŸã—",
                            "word_type": "pronoun",
                            "position": 0,
                            "grammar_info": {
                                "meaning": "æˆ‘",
                                "category": "äººç§°ä»£è¯"
                            }
                        },
                        {
                            "word_jp": "ã¯",
                            "hiragana": "ã¯",
                            "word_type": "particle",
                            "position": 1,
                            "grammar_info": {
                                "meaning": "ä¸»é¢˜åŠ©è¯",
                                "function": "æ ‡è®°å¥å­ä¸»é¢˜"
                            }
                        },
                        {
                            "word_jp": "å­¦ç”Ÿ",
                            "hiragana": "ãŒãã›ã„",
                            "word_type": "noun",
                            "position": 2,
                            "grammar_info": {
                                "meaning": "å­¦ç”Ÿ",
                                "category": "èŒä¸š/èº«ä»½"
                            }
                        },
                        {
                            "word_jp": "ã§ã™",
                            "hiragana": "ã§ã™",
                            "word_type": "aux_verb",
                            "position": 3,
                            "grammar_info": {
                                "meaning": "æ˜¯ï¼ˆç¤¼è²Œä½“ï¼‰",
                                "function": "åˆ¤æ–­åŠ©åŠ¨è¯"
                            }
                        }
                    ]
                };
            } else {
                // æ‰¹é‡ç¤ºä¾‹ï¼ˆå«AIé¢„åˆ†è¯ï¼‰
                example = [
                    {
                        "content_type": "sentence",
                        "original_jp": "ã§ã‚“ã—ã‚ƒã¯ã‚‚ã†ã™ãæ¥ã¾ã™ã‹",
                        "hiragana": "ã§ã‚“ã—ã‚ƒã¯ã‚‚ã†ã™ããã¾ã™ã‹",
                        "romaji": "densha wa mousugu kimasu ka",
                        "chinese_meaning": "ç«è½¦å¾ˆå¿«å°±ä¼šæ¥å—ï¼Ÿ",
                        "tags": {
                            "grammar_points": ["ã¯ï¼ˆä¸»é¢˜æ ‡è®°ï¼‰", "ã‚‚ã†ã™ãï¼ˆæ—¶é—´å‰¯è¯ï¼‰", "ã¾ã™ï¼ˆæ•¬ä½“ï¼‰", "ã‹ï¼ˆç–‘é—®åŠ©è¯ï¼‰"],
                            "scene": "äº¤é€š/è¯¢é—®",
                            "difficulty": 1
                        },
                        "segmented_words": [
                            {"word_jp": "ã§ã‚“ã—ã‚ƒ", "hiragana": "ã§ã‚“ã—ã‚ƒ", "word_type": "noun", "position": 0, "grammar_info": {"meaning": "ç«è½¦"}},
                            {"word_jp": "ã¯", "hiragana": "ã¯", "word_type": "particle", "position": 1, "grammar_info": {"meaning": "ä¸»é¢˜åŠ©è¯"}},
                            {"word_jp": "ã‚‚ã†ã™ã", "hiragana": "ã‚‚ã†ã™ã", "word_type": "adverb", "position": 2, "grammar_info": {"meaning": "å¾ˆå¿«"}},
                            {"word_jp": "æ¥ã¾ã™", "hiragana": "ãã¾ã™", "word_type": "verb", "position": 3, "grammar_info": {"meaning": "æ¥", "prototype": "æ¥ã‚‹", "form": "masu"}},
                            {"word_jp": "ã‹", "hiragana": "ã‹", "word_type": "particle", "position": 4, "grammar_info": {"meaning": "ç–‘é—®åŠ©è¯"}}
                        ]
                    },
                    {
                        "content_type": "sentence",
                        "original_jp": "æ±äº¬é§…ã¯çµ‚ç‚¹ã§ã™ã‹ã€‚",
                        "hiragana": "ã¨ã†ãã‚‡ã†ãˆãã¯ã—ã‚…ã†ã¦ã‚“ã§ã™ã‹ã€‚",
                        "romaji": "toukyou eki wa shuuten desu ka",
                        "chinese_meaning": "ä¸œäº¬ç«™æ˜¯ç»ˆç‚¹ç«™å—ï¼Ÿ",
                        "tags": {
                            "grammar_points": ["ã¯ï¼ˆä¸»é¢˜æ ‡è®°ï¼‰", "ã§ã™ï¼ˆåˆ¤æ–­åŠ©åŠ¨è¯ï¼‰", "ã‹ï¼ˆç–‘é—®åŠ©è¯ï¼‰"],
                            "scene": "äº¤é€š/è½¦ç«™",
                            "difficulty": 1
                        },
                        "segmented_words": [
                            {"word_jp": "æ±äº¬", "hiragana": "ã¨ã†ãã‚‡ã†", "word_type": "noun", "position": 0, "grammar_info": {"meaning": "ä¸œäº¬"}},
                            {"word_jp": "é§…", "hiragana": "ãˆã", "word_type": "noun", "position": 1, "grammar_info": {"meaning": "è½¦ç«™"}},
                            {"word_jp": "ã¯", "hiragana": "ã¯", "word_type": "particle", "position": 2, "grammar_info": {"meaning": "ä¸»é¢˜åŠ©è¯"}},
                            {"word_jp": "çµ‚ç‚¹", "hiragana": "ã—ã‚…ã†ã¦ã‚“", "word_type": "noun", "position": 3, "grammar_info": {"meaning": "ç»ˆç‚¹ç«™"}},
                            {"word_jp": "ã§ã™", "hiragana": "ã§ã™", "word_type": "aux_verb", "position": 4, "grammar_info": {"meaning": "æ˜¯ï¼ˆç¤¼è²Œä½“ï¼‰"}},
                            {"word_jp": "ã‹", "hiragana": "ã‹", "word_type": "particle", "position": 5, "grammar_info": {"meaning": "ç–‘é—®åŠ©è¯"}}
                        ]
                    }
                ];
            }
            
            document.getElementById('jsonInput').value = JSON.stringify(example, null, 2);
            
            // æ›´æ–°æ‰¹é‡æŒ‡ç¤ºå™¨
            const indicator = document.getElementById('batchIndicator');
            if (type === 'batch') {
                indicator.style.display = 'inline';
            } else {
                indicator.style.display = 'none';
            }
        }

        // æ¸…ç©ºè¾“å…¥
        function clearInput() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('batchIndicator').style.display = 'none';
        }

        // å¼€å§‹åˆ†æ‹£
        async function startSegmentation() {
            const jsonInput = document.getElementById('jsonInput').value;
            
            if (!jsonInput.trim()) {
                alert('è¯·å…ˆç²˜è´´JSONæ•°æ®');
                return;
            }

            let data;
            try {
                data = JSON.parse(jsonInput);
            } catch (e) {
                alert('JSONæ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥\né”™è¯¯ä¿¡æ¯: ' + e.message);
                return;
            }

            // å¦‚æœæ˜¯å•æ¡ï¼Œè½¬æ¢ä¸ºæ•°ç»„
            const isBatch = Array.isArray(data);
            const entries = isBatch ? data : [data];

            // éªŒè¯å¿…å¡«å­—æ®µ
            const required = ['original_jp', 'hiragana', 'chinese_meaning'];
            let missingSegmentation = [];
            
            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                for (const field of required) {
                    if (!entry[field]) {
                        alert(`ç¬¬${i + 1}æ¡æ•°æ®ç¼ºå°‘å¿…å¡«å­—æ®µ: ${field}`);
                        return;
                    }
                }
                
                // æ£€æŸ¥æ˜¯å¦æœ‰åˆ†è¯æ•°æ®
                if (!entry.segmented_words || entry.segmented_words.length === 0) {
                    missingSegmentation.push(i + 1);
                }
            }
            
            // è­¦å‘Šç¼ºå°‘åˆ†è¯çš„æ•°æ®
            if (missingSegmentation.length > 0) {
                const msg = `âš ï¸ è­¦å‘Šï¼šç¬¬ ${missingSegmentation.join(', ')} æ¡æ•°æ®ç¼ºå°‘ segmented_words åˆ†è¯æ•°æ®ã€‚\n\n` +
                           `ç¨‹åºå°†ä½¿ç”¨ä¸å‡†ç¡®çš„è‡ªåŠ¨åˆ†è¯ã€‚\n\n` +
                           `å»ºè®®ï¼šä½¿ç”¨ docs/08-JSONå½•å…¥æ¨¡æ¿.md ä¸­çš„æç¤ºè¯­è®©AIé¢„åˆ†è¯ã€‚\n\n` +
                           `æ˜¯å¦ç»§ç»­ï¼Ÿ`;
                if (!confirm(msg)) {
                    return;
                }
            }

            try {
                const response = await fetch('/api/entries/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)  // å‘é€åŸå§‹æ•°æ®ï¼ˆå•æ¡æˆ–æ•°ç»„ï¼‰
                });

                const result = await response.json();

                if (result.success) {
                    // ä¿å­˜é¢„è§ˆæ•°æ®åˆ°sessionStorage
                    sessionStorage.setItem('previewData', JSON.stringify(result.data));
                    // è·³è½¬åˆ°é¢„è§ˆé¡µé¢
                    window.location.href = 'preview.html';
                } else {
                    alert('é¢„è§ˆç”Ÿæˆå¤±è´¥: ' + (result.error?.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('è¯·æ±‚å¤±è´¥:', error);
                alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }
    </script>
</body>
</html>
