# 02-系统架构设计

> 言葉AI (Kotoba AI) 系统架构与数据流设计

---

## 2.1 整体架构

### 2.1.1 架构图

```mermaid
flowchart TB
    subgraph 用户层
        U1[用户]
        U2[多邻国APP]
        U3[豆包APP]
    end
    
    subgraph 识别层
        A1[AI助手<br/>Opencode]
    end
    
    subgraph 应用层
        subgraph Web应用
            F1[Flask后端]
            F2[API接口]
        end
        
        subgraph 前端界面
            P1[录入页面]
            P2[预览确认]
            P3[50音图表]
            P4[分类表]
            P5[每日一练]
        end
    end
    
    subgraph 服务层
        S1[分词服务]
        S2[动词处理]
        S3[索引服务]
        S4[练习生成]
    end
    
    subgraph 数据层
        D1[(SQLite<br/>数据库)]
        D2[uploads/<br/>截图文件]
    end
    
    U1 -->|截图| A1
    A1 -->|JSON数据| U1
    U1 -->|录入| P1
    P1 --> P2
    P2 -->|确认| F1
    F1 --> F2
    F2 --> S1
    F2 --> S2
    F2 --> S3
    F2 --> S4
    S1 --> D1
    S2 --> D1
    S3 --> D1
    S4 --> D1
    U1 -->|浏览| P3
    U1 -->|浏览| P4
    U1 -->|练习| P5
    P5 -->|Prompt| U3
    P1 -.->|保存| D2
```

### 2.1.2 分层说明

| 层级 | 职责 | 组件 |
|------|------|------|
| **用户层** | 学习场景、数据入口 | 多邻国、用户、豆包APP |
| **识别层** | AI识别日语内容 | Opencode助手 |
| **应用层** | Web应用核心 | Flask后端 + 前端页面 |
| **服务层** | 业务逻辑处理 | 分词、动词、索引、练习生成 |
| **数据层** | 数据持久化 | SQLite数据库 + 文件存储 |

---

## 2.2 数据流设计

### 2.2.1 核心数据流

```mermaid
flowchart LR
    subgraph 输入
        I1[截图]
        I2[AI识别结果]
    end
    
    subgraph 处理
        P1[原始录入]
        P2[预览分拣]
        P3[确认入库]
    end
    
    subgraph 存储
        S1[(raw_entries)]
        S2[(segmented_words)]
        S3[(verb_master)]
        S4[(verb_conjugations)]
        S5[(phonetic_index)]
    end
    
    subgraph 输出
        O1[50音检索]
        O2[分类表]
        O3[每日一练]
    end
    
    I1 --> I2
    I2 --> P1
    P1 --> P2
    P2 --> P3
    P3 --> S1
    P3 --> S2
    P3 --> S3
    P3 --> S4
    P3 --> S5
    S1 --> O1
    S2 --> O2
    S5 --> O1
    S3 --> O2
    S4 --> O2
    S1 --> O3
    S2 --> O3
```

### 2.2.2 详细数据流说明

#### 流1：录入流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant AI as AI助手
    participant Web as Web系统
    participant DB as SQLite
    
    U->>AI: 1. 发送截图
    AI->>AI: 2. 识别日语内容
    AI->>U: 3. 返回JSON数据
    U->>Web: 4. 粘贴JSON并提交
    Web->>Web: 5. 自动分词处理
    Web->>Web: 6. 识别动词并分析
    Web->>U: 7. 显示预览确认页
    U->>Web: 8. 确认/修改数据
    Web->>DB: 9. 写入raw_entries
    Web->>DB: 10. 写入segmented_words
    Web->>DB: 11. 写入verb_master/conjugations
    Web->>DB: 12. 写入phonetic_index
    Web->>U: 13. 入库成功
```

#### 流2：查询流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant Web as Web系统
    participant DB as SQLite
    
    U->>Web: 1. 点击50音「か」
    Web->>DB: 2. 查询phonetic_index
    DB->>Web: 3. 返回关联entry_ids
    Web->>DB: 4. 查询raw_entries详情
    DB->>Web: 5. 返回完整数据
    Web->>U: 6. 展示结果列表
    U->>Web: 7. 点击具体条目
    Web->>DB: 8. 查询segmented_words
    DB->>Web: 9. 返回分词详情
    Web->>U: 10. 展示完整信息
```

#### 流3：每日一练流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant Web as Web系统
    participant Algo as 选题算法
    participant DB as SQLite
    
    U->>Web: 1. 打开每日一练
    Web->>Algo: 2. 请求生成题目
    Algo->>DB: 3. 查询最近学习内容
    DB->>Algo: 4. 返回数据
    Algo->>Algo: 5. 计算权重并选题
    Algo->>Web: 6. 返回20道题目
    Web->>U: 7. 展示题目列表
    U->>Web: 8. 选择语音练习
    Web->>Web: 9. 生成豆包Prompt
    Web->>U: 10. 显示Prompt文本
    U->>U: 11. 复制到豆包APP
```

---

## 2.3 模块划分

### 2.3.1 模块结构图

```mermaid
flowchart TB
    subgraph 前端模块
        F1[录入模块]
        F2[预览模块]
        F3[检索模块]
        F4[分类模块]
        F5[练习模块]
    end
    
    subgraph 后端模块
        B1[API路由层]
        B2[业务服务层]
        B3[数据访问层]
    end
    
    subgraph 服务模块
        S1[分词服务<br/>Segmenter]
        S2[动词处理<br/>VerbProcessor]
        S3[索引服务<br/>PhoneticIndexer]
        S4[练习生成<br/>PracticeGenerator]
    end
    
    subgraph 数据模块
        D1[原始数据<br/>RawEntry]
        D2[分词数据<br/>SegmentedWord]
        D3[动词数据<br/>VerbMaster]
        D4[索引数据<br/>PhoneticIndex]
    end
    
    F1 --> B1
    F2 --> B1
    F3 --> B1
    F4 --> B1
    F5 --> B1
    
    B1 --> B2
    B2 --> B3
    
    B2 --> S1
    B2 --> S2
    B2 --> S3
    B2 --> S4
    
    B3 --> D1
    B3 --> D2
    B3 --> D3
    B3 --> D4
    
    S1 --> D2
    S2 --> D3
    S3 --> D4
```

### 2.3.2 模块职责

| 模块 | 职责 | 关键功能 |
|------|------|----------|
| **录入模块** | 接收用户输入 | JSON解析、数据验证、提交预览 |
| **预览模块** | 展示分词结果 | 分词列表、动词编辑、确认/回滚 |
| **检索模块** | 50音图表检索 | 图表展示、点击检索、结果展示 |
| **分类模块** | 词性分类展示 | 名词/动词/形容词/助词表 |
| **练习模块** | 每日一练 | 选题生成、Prompt生成 |
| **API路由层** | HTTP接口 | RESTful路由、参数解析、响应封装 |
| **业务服务层** | 业务逻辑协调 | 调用服务、事务管理、数据组装 |
| **数据访问层** | 数据库操作 | CRUD、查询构建、连接管理 |
| **分词服务** | 自动分词 | 日文分词、词性标注、索引生成 |
| **动词处理** | 动词识别和活用 | 原型识别、变形分析、活用生成 |
| **索引服务** | 50音索引 | 假名提取、索引映射、查询优化 |
| **练习生成** | 智能选题 | 权重计算、随机选题、Prompt组装 |

---

## 2.4 技术架构决策

### 2.4.1 为什么选择Flask？

```mermaid
graph LR
    A[Flask] --> B[轻量]
    A --> C[灵活]
    A --> D[文档丰富]
    A --> E[社区活跃]
    
    B --> B1[仅核心功能<br/>按需扩展]
    C --> C1[无强制约束<br/>自由组织代码]
    D --> D1[学习成本低<br/>快速上手]
    E --> E1[插件丰富<br/>问题易解决]
```

### 2.4.2 为什么选择SQLite？

```mermaid
graph LR
    A[SQLite] --> B[零配置]
    A --> C[单文件]
    A --> D[JSON支持]
    A --> E[Python内置]
    
    B --> B1[无需安装服务<br/>开箱即用]
    C --> C1[备份简单<br/>复制.db文件]
    D --> D1[灵活的schema<br/>非结构化数据]
    E --> E1[标准库支持<br/>无额外依赖]
```

### 2.4.3 为什么选择DaisyUI？

```mermaid
graph LR
    A[DaisyUI] --> B[美观]
    A --> C[轻量]
    A --> D[主题丰富]
    A --> E[易用]
    
    B --> B1[专业设计<br/>一致性好]
    C --> C1[基于Tailwind<br/>无额外JS]
    D --> D1[多主题切换<br/>含日式风格]
    E --> E1[HTML即可<br/>无需构建]
```

---

## 2.5 扩展性设计

### 2.5.1 预留云端部署接口

```mermaid
flowchart TB
    subgraph 当前架构
        A1[Flask内置服务器]
        A2[SQLite本地文件]
        A3[本地静态文件]
    end
    
    subgraph 云端架构预留
        B1[Gunicorn/uWSGI]
        B2[PostgreSQL/MySQL]
        B3[CDN静态资源]
        B4[Redis缓存]
    end
    
    A1 -.->|替换| B1
    A2 -.->|迁移| B2
    A3 -.->|迁移| B3
    
    style B1 fill:#e1f5ff
    style B2 fill:#e1f5ff
    style B3 fill:#e1f5ff
    style B4 fill:#e1f5ff
```

### 2.5.2 移动端兼容性预留

```mermaid
flowchart LR
    A[响应式设计] --> B[桌面优先]
    A --> C[移动端适配]
    
    B --> B1[当前主要使用场景]
    C --> C1[预留媒体查询]
    C --> C2[触摸事件支持]
    C --> C3[简化UI布局]
    
    style C fill:#e1f5ff
```

### 2.5.3 插件化设计

```mermaid
flowchart TB
    subgraph 核心系统
        C1[录入]
        C2[检索]
        C3[练习]
    end
    
    subgraph 扩展插件预留
        E1[新教材适配器]
        E2[新题型生成器]
        E3[统计图表插件]
        E4[社区分享功能]
    end
    
    C1 -.->|接口预留| E1
    C3 -.->|接口预留| E2
    C2 -.->|接口预留| E3
    C3 -.->|接口预留| E4
    
    style E1 fill:#e1f5ff
    style E2 fill:#e1f5ff
    style E3 fill:#e1f5ff
    style E4 fill:#e1f5ff
```

---

## 2.6 性能考虑

### 2.6.1 当前优化

| 优化点 | 策略 | 预期效果 |
|--------|------|----------|
| 数据库查询 | 合理索引 | <100ms查询 |
| 静态资源 | CDN引入DaisyUI | 快速加载 |
| 分词处理 | 异步处理 | 不阻塞UI |
| 数据分页 | 分页加载 | 流畅浏览 |

### 2.6.2 未来优化预留

- **缓存层**：Redis缓存热点数据
- **CDN**：静态资源CDN加速
- **数据库优化**：读写分离、连接池
- **前端优化**：懒加载、虚拟滚动

---

## 2.7 安全考虑

### 2.7.1 当前安全措施

```mermaid
flowchart TB
    subgraph 安全防护
        S1[输入验证]
        S2[SQL注入防护]
        S3[XSS防护]
        S4[CSRF防护]
    end
    
    subgraph 实现方式
        I1[WTForms验证]
        I2[参数化查询]
        I3[模板转义]
        I4[Flask-WTF]
    end
    
    S1 --> I1
    S2 --> I2
    S3 --> I3
    S4 --> I4
```

### 2.7.2 数据安全

- **本地存储**：数据仅存储在用户本地
- **无网络传输**：敏感数据不上传云端
- **定期备份**：脚本自动化备份数据库

---

**文档版本**: v1.0  
**创建日期**: 2026-02-11
