
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>言葉AI Code Canvas — 代码架构详解</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600&family=Noto+Serif+SC:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ink': '#0a0a0c',
                        'ink-light': '#12121a',
                        'vermilion': '#dc2626',
                        'vermilion-glow': '#ef4444',
                        'gold': '#d4af37',
                        'gold-dim': '#a0822e',
                        'parchment': '#f5f0e6',
                        'sakura': '#ffb7c5',
                        'jade': '#00a86b',
                        'indigo-deep': '#1e1b4b',
                        'slate-warm': '#64748b'
                    },
                    fontFamily: {
                        'mono': ['JetBrains Mono', 'monospace'],
                        'serif': ['Noto Serif SC', 'serif'],
                        'display': ['Playfair Display', 'serif']
                    },
                    boxShadow: {
                        'vermilion': '0 0 30px rgba(220, 38, 38, 0.3)',
                        'gold': '0 0 20px rgba(212, 175, 55, 0.2)',
                        'inner-glow': 'inset 0 1px 0 rgba(255,255,255,0.05)'
                    }
                }
            }
        }
    </script>
    <style>
        :root {
            --bg-primary: #0a0a0c;
            --bg-secondary: #12121a;
            --accent-primary: #dc2626;
            --accent-secondary: #d4af37;
        }
        
        *::before, *::after {
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
        }
        
        body {
            background: var(--bg-primary);
            font-family: 'Noto Serif SC', serif;
            color: #e5e5e5;
            overflow-x: hidden;
        }
        
        /* Noise texture overlay */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.03;
            z-index: 1000;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        
        /* Japanese pattern background */
        .japanese-pattern {
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(220, 38, 38, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                linear-gradient(135deg, rgba(30, 27, 75, 0.3) 0%, transparent 50%);
        }
        
        /* Code block styling - Japanese woodblock aesthetic */
        .code-block {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.7;
            background: linear-gradient(180deg, #0f0f14 0%, #0a0a0c 100%);
            border: 1px solid rgba(220, 38, 38, 0.15);
            border-left: 3px solid var(--accent-primary);
            position: relative;
        }
        
        .code-block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(220, 38, 38, 0.3) 50%, transparent 100%);
        }
        
        .line-number {
            color: #4b5563;
            text-align: right;
            padding-right: 1.2em;
            user-select: none;
            border-right: 1px solid rgba(220, 38, 38, 0.1);
            margin-right: 1.2em;
            min-width: 50px;
            font-weight: 300;
        }
        
        .code-line {
            display: flex;
            padding: 3px 0;
            transition: all 0.2s ease;
        }
        
        .code-line:hover {
            background: rgba(220, 38, 38, 0.05);
        }
        
        /* Annotation cards - Japanese scroll aesthetic */
        .annotation {
            background: linear-gradient(135deg, rgba(18, 18, 26, 0.95) 0%, rgba(30, 27, 75, 0.3) 100%);
            border-left: 3px solid var(--accent-primary);
            border-right: 1px solid rgba(212, 175, 55, 0.2);
            padding: 14px 18px;
            margin: 12px 0;
            position: relative;
            box-shadow: 
                0 4px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.03);
        }
        
        .annotation::before {
            content: '▸';
            position: absolute;
            left: -12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-primary);
            font-size: 8px;
            background: var(--bg-primary);
            padding: 2px;
        }
        
        .annotation.warning {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, rgba(69, 26, 3, 0.3) 0%, rgba(18, 18, 26, 0.95) 100%);
        }
        
        .annotation.danger {
            border-left-color: #ef4444;
            background: linear-gradient(135deg, rgba(69, 10, 10, 0.4) 0%, rgba(18, 18, 26, 0.95) 100%);
            border-right-color: rgba(239, 68, 68, 0.3);
            animation: pulse-danger 2s ease-in-out infinite;
        }
        
        @keyframes pulse-danger {
            0%, 100% { box-shadow: 0 4px 20px rgba(239, 68, 68, 0.1); }
            50% { box-shadow: 0 4px 30px rgba(239, 68, 68, 0.25); }
        }
        
        .annotation.success {
            border-left-color: #00a86b;
            background: linear-gradient(135deg, rgba(6, 78, 59, 0.2) 0%, rgba(18, 18, 26, 0.95) 100%);
        }
        
        /* Navigation styling */
        .nav-container {
            background: linear-gradient(180deg, rgba(18, 18, 26, 0.98) 0%, rgba(10, 10, 12, 0.99) 100%);
            border-right: 1px solid rgba(220, 38, 38, 0.1);
            backdrop-filter: blur(20px);
        }
        
        .nav-item {
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 10px 16px;
            margin: 4px 8px;
            border-radius: 6px;
            position: relative;
            overflow: hidden;
        }
        
        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent-primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }
        
        .nav-item:hover {
            background: rgba(220, 38, 38, 0.08);
            transform: translateX(4px);
        }
        
        .nav-item:hover::before {
            transform: scaleY(1);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(220, 38, 38, 0.15) 0%, rgba(220, 38, 38, 0.05) 100%);
            color: #fff;
        }
        
        .nav-item.active::before {
            transform: scaleY(1);
        }
        
        /* Section display */
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Mermaid diagram styling */
        .mermaid {
            background: rgba(18, 18, 26, 0.6);
            border: 1px solid rgba(220, 38, 38, 0.1);
            border-radius: 12px;
            padding: 24px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(220, 38, 38, 0.3);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(220, 38, 38, 0.5);
        }
        
        /* Syntax highlighting */
        .keyword { color: #ff6b6b; font-weight: 500; }
        .string { color: #ffd93d; }
        .function { color: #6bcf7f; }
        .comment { color: #6b7280; font-style: italic; }
        .number { color: #74c0fc; }
        .class-name { color: #ffb366; }
        .self { color: #c084fc; }
        
        /* Decorative elements */
        .decoration-circle {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            filter: blur(80px);
            opacity: 0.15;
            z-index: -1;
        }
        
        .decoration-1 {
            width: 600px;
            height: 600px;
            background: radial-gradient(circle, var(--accent-primary) 0%, transparent 70%);
            top: -200px;
            right: -200px;
        }
        
        .decoration-2 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, var(--accent-secondary) 0%, transparent 70%);
            bottom: -100px;
            left: -100px;
        }
        
        /* Tree line styling */
        .tree-line {
            border-left: 1px solid rgba(220, 38, 38, 0.15);
            margin-left: 16px;
            padding-left: 12px;
            position: relative;
        }
        
        .tree-line::before {
            content: '';
            position: absolute;
            left: -1px;
            top: 0;
            bottom: 0;
            width: 1px;
            background: linear-gradient(180deg, transparent 0%, rgba(220, 38, 38, 0.3) 50%, transparent 100%);
        }
        
        /* Stat cards */
        .stat-card {
            background: linear-gradient(135deg, rgba(18, 18, 26, 0.8) 0%, rgba(30, 27, 75, 0.2) 100%);
            border: 1px solid rgba(220, 38, 38, 0.1);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(220, 38, 38, 0.2);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--accent-primary) 50%, transparent 100%);
            opacity: 0.3;
        }
        
        /* Section title */
        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, #fff 0%, rgba(220, 38, 38, 0.3) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            margin-bottom: 2rem;
        }
        
        .section-title::after {
            content: 'コード';
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            font-family: 'JetBrains Mono', monospace;
            color: rgba(220, 38, 38, 0.2);
            -webkit-text-fill-color: rgba(220, 38, 38, 0.2);
        }
        </style>
        <style>
            .test-status { padding: 4px 8px; border-radius: 999px; font-family: ui-monospace, SFMono-Regular, monospace; font-size: 12px; background: rgba(0,0,0,0.4); color: #fff; margin-left: 8px; }
            .test-pass { background: #28a745; }
            .test-fail { background: #d73a49; }
        </style>
</head>
<body class="min-h-screen japanese-pattern">
    <!-- Noise overlay -->
    <div class="noise-overlay"></div>
    
    <!-- Decorative background elements -->
    <div class="decoration-circle decoration-1"></div>
    <div class="decoration-circle decoration-2"></div>
    
    <!-- Top Navigation Bar -->
    <nav class="fixed top-0 left-0 right-0 z-50 bg-ink/90 backdrop-blur-xl border-b border-vermilion/10">
        <div class="mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-vermilion to-vermilion-glow flex items-center justify-center shadow-vermilion">
                            <span class="text-white font-serif text-lg font-bold">言</span>
                        </div>
                        <div>
                            <h1 class="text-xl font-bold text-white tracking-wide">
                                言葉<span class="text-vermilion">AI</span>
                            </h1>
                            <p class="text-xs text-slate-warm font-mono">Kotoba AI Code Canvas</p>
                        </div>
                    </div>
                    <div class="h-8 w-px bg-vermilion/20"></div>
                    <span class="text-slate-warm text-sm font-serif">代码架构详解</span>
                </div>
                
                <div class="flex items-center space-x-6 text-sm">
                    <div class="flex items-center space-x-2 text-slate-warm">
                        <span class="w-2 h-2 rounded-full bg-jade animate-pulse"></span>
                        <span class="font-mono">Python 3.8+</span>
                    </div>
                    <div class="flex items-center space-x-2 text-slate-warm">
                        <span class="w-2 h-2 rounded-full bg-gold"></span>
                        <span class="font-mono">Flask</span>
                    </div>
                    <div class="flex items-center space-x-2 text-slate-warm">
                        <span class="w-2 h-2 rounded-full bg-vermilion"></span>
                        <span class="font-mono">SQLite</span>
                    </div>
                </div>
                <!-- Test status badge -->
                <div id="test-status" class="test-status">Test: PENDING</div>
            </div>
        </div>
    </nav>

    <div class="flex pt-20">
        <!-- Left Sidebar -->
        <aside class="nav-container w-80 h-[calc(100vh-80px)] sticky top-20 overflow-y-auto">
            <div class="p-6">
                <div class="mb-8">
                    <h3 class="text-xs font-mono text-slate-warm uppercase tracking-widest mb-4 flex items-center">
                        <span class="w-4 h-px bg-vermilion/50 mr-2"></span>
                        Project Structure
                    </h3>
                </div>
                
<div class="nav-item active flex items-center mb-2 text-sm" onclick="showSection('overview', this)">
                    <span class="mr-3 text-vermilion text-lg">◈</span>
                    <span class="font-serif">项目概览</span>
                </div>
                
                <div class="mt-8">
                    <h4 class="text-xs font-mono text-slate-warm/60 uppercase tracking-widest mb-4 px-4">
                        Backend Core
                    </h4>
                    <div class="tree-line space-y-1">
<div class="nav-item flex items-center text-sm" onclick="showSection('app', this)">
                            <span class="mr-3 text-gold">⚡</span>
                            <span class="font-mono text-sm">app.py</span>
                            <span class="ml-auto text-xs text-slate-warm/40">Factory</span>
                        </div>
<div class="nav-item flex items-center text-sm" onclick="showSection('config', this)">
                            <span class="mr-3 text-gold">⚙</span>
                            <span class="font-mono text-sm">config.py</span>
                            <span class="ml-auto text-xs text-slate-warm/40">Config</span>
                        </div>
<div class="nav-item flex items-center text-sm" onclick="showSection('database', this)">
                            <span class="mr-3 text-gold">◉</span>
                            <span class="font-mono text-sm">database.py</span>
                            <span class="ml-auto text-xs text-slate-warm/40">DAO</span>
                        </div>
<div class="nav-item flex items-center text-sm" onclick="showSection('models', this)">
                            <span class="mr-3 text-gold">◆</span>
                            <span class="font-mono text-sm">models/</span>
                            <span class="ml-auto text-xs text-slate-warm/40">Data</span>
                        </div>
<div class="nav-item flex items-center text-sm" onclick="showSection('entries', this)">
                            <span class="mr-3 text-vermilion">✎</span>
                            <span class="font-mono text-sm">entries.py</span>
                            <span class="ml-auto text-xs text-slate-warm/40">API</span>
                        </div>
<div class="nav-item flex items-center text-sm" onclick="showSection('segmenter', this)">
                            <span class="mr-3 text-vermilion">✂</span>
                            <span class="font-mono text-sm">segmenter.py</span>
                            <span class="ml-auto text-xs text-slate-warm/40">NLP</span>
                        </div>
<div class="nav-item flex items-center text-sm" onclick="showSection('practice', this)">
                            <span class="mr-3 text-vermilion">◎</span>
                            <span class="font-mono text-sm">practice.py</span>
                            <span class="ml-auto text-xs text-slate-warm/40">Algo</span>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h4 class="text-xs font-mono text-slate-warm/60 uppercase tracking-widest mb-4 px-4">
                        Visualization
                    </h4>
                    <div class="tree-line space-y-1">
<div class="nav-item flex items-center text-sm" onclick="showSection('dataflow', this)">
                            <span class="mr-3 text-jade">~</span>
                            <span class="font-serif">数据流图</span>
                        </div>
<div class="nav-item flex items-center text-sm" onclick="showSection('erd', this)">
                            <span class="mr-3 text-jade">❋</span>
                            <span class="font-serif">数据库ERD</span>
                        </div>
<div class="nav-item flex items-center text-sm" onclick="showSection('api', this)">
                            <span class="mr-3 text-jade">⇄</span>
                            <span class="font-serif">API调用链</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Bottom decoration -->
            <div class="absolute bottom-6 left-6 right-6">
                <div class="text-center">
                    <div class="text-vermilion/30 text-4xl font-serif mb-2">言葉</div>
                    <div class="text-xs text-slate-warm/40 font-mono">Code Architecture</div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-8 overflow-x-auto">
            
            <!-- Overview Section -->
            <div id="overview" class="section active">
                <h2 class="section-title">Project Overview</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="stat-card rounded-xl p-6">
                        <h3 class="text-lg font-serif text-gold mb-4 flex items-center">
                            <span class="mr-2">◈</span> 技术架构
                        </h3>
                        <div class="mermaid text-sm">
flowchart TB
    subgraph Frontend["Frontend Layer"]
        A[HTML5 + Tailwind] --> B[Vanilla JS]
        B --> C[DaisyUI]
    end
    
    subgraph API["API Layer"]
        D[Flask Blueprints] --> E[RESTful Routes]
        E --> F[CORS Middleware]
    end
    
    subgraph Service["Service Layer"]
        G[JapaneseSegmenter] --> H[VerbConjugator]
        G --> I[Data Models]
    end
    
    subgraph Data["Data Layer"]
        J[SQLite] --> K[Connection Pool]
    end
    
    Frontend <-->|HTTP/JSON| API
    API -->|Call| Service
    Service -->|CRUD| Data
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="stat-card rounded-xl p-6">
                            <h3 class="text-lg font-serif text-vermilion mb-4 flex items-center">
                                <span class="mr-2">◈</span> 代码统计
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="text-center p-4 rounded-lg bg-ink-light/50 border border-vermilion/10">
                                    <div class="text-3xl font-bold text-vermilion font-mono">11</div>
                                    <div class="text-xs text-slate-warm mt-1">Python 文件</div>
                                </div>
                                <div class="text-center p-4 rounded-lg bg-ink-light/50 border border-gold/10">
                                    <div class="text-3xl font-bold text-gold font-mono">2K+</div>
                                    <div class="text-xs text-slate-warm mt-1">代码行数</div>
                                </div>
                                <div class="text-center p-4 rounded-lg bg-ink-light/50 border border-jade/10">
                                    <div class="text-3xl font-bold text-jade font-mono">6</div>
                                    <div class="text-xs text-slate-warm mt-1">数据库表</div>
                                </div>
                                <div class="text-center p-4 rounded-lg bg-ink-light/50 border border-vermilion/10">
                                    <div class="text-3xl font-bold text-vermilion-glow font-mono">15+</div>
                                    <div class="text-xs text-slate-warm mt-1">API 端点</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="stat-card rounded-xl p-6">
                            <h3 class="text-sm font-mono text-slate-warm uppercase tracking-widest mb-4">
                                Core Features
                            </h3>
                            <div class="space-y-2 text-sm">
                                <div class="flex items-center text-slate-warm">
                                    <span class="w-2 h-2 rounded-full bg-vermilion mr-3"></span>
                                    AI辅助录入与自动分词
                                </div>
                                <div class="flex items-center text-slate-warm">
                                    <span class="w-2 h-2 rounded-full bg-gold mr-3"></span>
                                    动词12种活用形式生成
                                </div>
                                <div class="flex items-center text-slate-warm">
                                    <span class="w-2 h-2 rounded-full bg-jade mr-3"></span>
                                    50音图表智能检索
                                </div>
                                <div class="flex items-center text-slate-warm">
                                    <span class="w-2 h-2 rounded-full bg-vermilion mr-3"></span>
                                    间隔重复练习算法
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- App.py Section -->
            <div id="app" class="section">
                <h2 class="section-title">Application Factory</h2>
                <p class="text-slate-warm mb-6 font-serif">Flask 应用工厂模式实现 — 多环境配置与蓝图注册中心</p>
                
                <div class="code-block rounded-xl p-6 mb-6">
                    <div class="annotation success">
                        <strong class="text-gold">◈ 核心概念：</strong>Application Factory Pattern<br>
                        允许创建多个应用实例，便于测试和配置切换，是 Flask 大型应用的标准组织方式
                    </div>

                    <div class="code-line">
                        <span class="line-number">01</span>
                        <span><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, jsonify, send_from_directory</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">02</span>
                        <span><span class="keyword">from</span> flask_cors <span class="keyword">import</span> CORS</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">04</span>
                        <span><span class="keyword">from</span> .config <span class="keyword">import</span> config</span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-vermilion">◉</strong> 第1-4行：导入依赖<br>
                        Flask 框架核心、CORS 跨域支持、多环境配置管理
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">13</span>
                        <span><span class="keyword">def</span> <span class="function">create_app</span>(config_name=<span class="string">'default'</span>):</span>
                    </div>
                    
                    <div class="annotation success">
                        <strong class="text-jade">◆</strong> 第13行：应用工厂函数<br>
                        接收 config_name 参数，返回配置好的 Flask 应用实例
                    </div>

                    <div class="code-line mt-2">
                        <span class="line-number">16</span>
                        <span>    project_root = os.path.dirname(os.path.dirname(os.path.dirname(<span class="self">__file__</span>)))</span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-gold">◈</strong> 第16行：路径计算<br>
                        通过3次 dirname 从 backend/app.py 定位到项目根目录
                    </div>

                    <div class="code-line mt-2">
                        <span class="line-number">19</span>
                        <span>    app = Flask(<span class="self">__name__</span>, static_folder=frontend_dir, static_url_path=<span class="string">''</span>)</span>
                    </div>
                    
                    <div class="annotation success">
                        <strong class="text-jade">◆</strong> 第19行：Flask 实例化<br>
                        static_url_path='' 让静态文件可直接通过根路径访问
                    </div>

                    <div class="code-line mt-2">
                        <span class="line-number">26</span>
                        <span>    app.config.from_object(config[config_name])</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">30</span>
                        <span>    CORS(app, resources={r<span class="string">"/api/*"</span>: {<span class="string">"origins"</span>: <span class="string">"*"</span>}})</span>
                    </div>
                    
                    <div class="annotation warning">
                        <strong class="text-gold">⚠</strong> 第30行：CORS 配置<br>
                        origins="*" 允许所有来源访问，生产环境应当限制
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">39</span>
                        <span>    app.register_blueprint(entries_bp)</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">40</span>
                        <span>    app.register_blueprint(phonetics_bp)</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">41</span>
                        <span>    app.register_blueprint(practice_bp)</span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-vermilion">◉</strong> 第39-41行：蓝图注册<br>
                        模块化路由组织，每个蓝图对应一个功能模块
                    </div>
                </div>
            </div>

            <!-- Config Section -->
            <div id="config" class="section">
                <h2 class="section-title">Configuration</h2>
                <p class="text-slate-warm mb-6 font-serif">多环境配置管理 — 支持开发、测试、生产环境无缝切换</p>
                
                <div class="code-block rounded-xl p-6 mb-6">
                    <div class="annotation success">
                        <strong class="text-gold">◈ 设计模式：</strong>配置类继承 + 工厂模式
                    </div>

                    <div class="code-line">
                        <span class="line-number">03</span>
                        <span><span class="keyword">class</span> <span class="class-name">Config</span>:</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">10</span>
                        <span>    DATABASE_PATH = os.path.join(BASE_DIR, <span class="string">'data/japanese_learning.db'</span>)</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">14</span>
                        <span>    MAX_CONTENT_LENGTH = <span class="number">16</span> * <span class="number">1024</span> * <span class="number">1024</span></span>
                    </div>
                    
                    <div class="code-line mt-4">
                        <span class="line-number">18</span>
                        <span>    SECRET_KEY = os.environ.get(<span class="string">'KOTOBA_SECRET_KEY'</span>) <span class="keyword">or</span> <span class="string">'hardcoded-secret'</span></span>
                    </div>
                    
                    <div class="annotation warning">
                        <strong class="text-gold">⚠ 安全风险：</strong>第18行存在硬编码密钥回退值，生产环境必须设置环境变量
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">35</span>
                        <span><span class="keyword">class</span> <span class="class-name">DevelopmentConfig</span>(Config):</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">37</span>
                        <span>    DEBUG = <span class="keyword">True</span></span>
                    </div>
                    
                    <div class="code-line mt-2">
                        <span class="line-number">43</span>
                        <span><span class="keyword">class</span> <span class="class-name">TestingConfig</span>(Config):</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">47</span>
                        <span>    DATABASE_PATH = <span class="string">':memory:'</span>  <span class="comment"># 内存数据库</span></span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-vermilion">◉</strong> 环境配置类<br>
                        DevelopmentConfig 开启调试，TestingConfig 使用内存数据库自动清理
                    </div>
                </div>
            </div>

            <!-- Database Section -->
            <div id="database" class="section">
                <h2 class="section-title">Database Layer</h2>
                <p class="text-slate-warm mb-6 font-serif">SQLite 数据访问层 — 上下文管理器实现事务安全</p>
                
                <div class="code-block rounded-xl p-6 mb-6">
                    <div class="annotation success">
                        <strong class="text-gold">◈ 核心概念：</strong>@contextmanager 装饰器实现 with 语句自动管理连接生命周期
                    </div>

                    <div class="code-line">
                        <span class="line-number">17</span>
                        <span>    <span class="keyword">@staticmethod</span></span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">18</span>
                        <span>    <span class="keyword">@contextmanager</span></span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">19</span>
                        <span>    <span class="keyword">def</span> <span class="function">get_connection</span>(db_path=<span class="keyword">None</span>):</span>
                    </div>
                    
                    <div class="code-line mt-4">
                        <span class="line-number">34</span>
                        <span>        conn = sqlite3.connect(path)</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">35</span>
                        <span>        conn.row_factory = sqlite3.Row</span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-vermilion">◉</strong> 第35行：row_factory<br>
                        允许通过列名访问数据，如 row['hiragana'] 而非 row[2]
                    </div>

                    <div class="code-line mt-2">
                        <span class="line-number">37</span>
                        <span>            <span class="keyword">yield</span> conn</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">38</span>
                        <span>            conn.commit()</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">40</span>
                        <span>            conn.rollback()</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">43</span>
                        <span>            conn.close()</span>
                    </div>
                    
                    <div class="annotation success">
                        <strong class="text-jade">◆</strong> 事务管理核心逻辑<br>
                        yield 返回连接 → commit 成功提交 → rollback 失败回滚 → finally 确保关闭
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">55</span>
                        <span>        content_type TEXT NOT NULL CHECK(content_type IN (<span class="string">'sentence'</span>, <span class="string">'word'</span>, <span class="string">'phrase'</span>)),</span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-gold">◈</strong> CHECK 约束<br>
                        数据库级别的数据验证，防止脏数据进入
                    </div>

                    <div class="code-line mt-2">
                        <span class="line-number">81</span>
                        <span>        FOREIGN KEY (raw_entry_id) REFERENCES raw_entries(id) ON DELETE CASCADE,</span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-vermilion">◉</strong> 外键级联<br>
                        ON DELETE CASCADE: 删除 raw_entries 时自动删除关联分词
                    </div>
                </div>
            </div>

            <!-- Models Section -->
            <div id="models" class="section">
                <h2 class="section-title">Data Models</h2>
                <p class="text-slate-warm mb-6 font-serif">@dataclass 数据模型 — Python 3.7+ 的类型注解与自动代码生成</p>
                
                <div class="code-block rounded-xl p-6 mb-6">
                    <div class="annotation success">
                        <strong class="text-gold">◈</strong> Dataclass 自动为类生成 __init__, __repr__, __eq__ 等方法，减少样板代码约 80%
                    </div>

                    <div class="code-line">
                        <span class="line-number">05</span>
                        <span><span class="keyword">@dataclass</span></span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">06</span>
                        <span><span class="keyword">class</span> <span class="class-name">RawEntry</span>:</span>
                    </div>

                    <div class="code-line mt-2">
                        <span class="line-number">16</span>
                        <span>    tags: Dict[<span class="class-name">str</span>, Any] = field(default_factory=<span class="class-name">dict</span>)</span>
                    </div>
                    
                    <div class="annotation warning">
                        <strong class="text-gold">⚠</strong> field(default_factory=dict) 避免可变默认值陷阱<br>
                        错误: tags = {} → 所有实例共享同一个 dict<br>
                        正确: default_factory=dict → 每个实例独立 dict
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">31</span>
                        <span>            <span class="string">'created_at'</span>: <span class="self">self</span>.created_at.isoformat() <span class="keyword">if</span> <span class="self">self</span>.created_at <span class="keyword">else</span> <span class="keyword">None</span>,</span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-vermilion">◉</strong> isoformat() 将 datetime 转 ISO 8601 格式<br>
                        Flask jsonify 不能处理 datetime，需要手动序列化
                    </div>
                </div>
            </div>

            <!-- Entries Section -->
            <div id="entries" class="section">
                <h2 class="section-title">Entry Routes</h2>
                <p class="text-slate-warm mb-6 font-serif">RESTful API 实现 — 预览-确认-入库完整流程</p>
                
                <div class="code-block rounded-xl p-6 mb-6">
                    <div class="code-line">
                        <span class="line-number">07</span>
                        <span>entries_bp = Blueprint(<span class="string">'entries'</span>, <span class="self">__name__</span>, url_prefix=<span class="string">'/api/entries'</span>)</span>
                    </div>
                    
                    <div class="annotation success">
                        <strong class="text-jade">◆</strong> 蓝图定义最终路径: /api/entries/xxx
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">132</span>
                        <span><span class="keyword">@entries_bp.route</span>(<span class="string">'/preview'</span>, methods=[<span class="string">'POST'</span>])</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">133</span>
                        <span><span class="keyword">def</span> <span class="function">create_preview</span>():</span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-vermilion">◉</strong> /preview 支持批量和单条数据预览<br>
                        先不入库，让用户确认分词结果
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">333</span>
                        <span>            query += <span class="string">f' ORDER BY {order_by} {order}'</span></span>
                    </div>
                    
                    <div class="annotation danger">
                        <strong class="text-gold">◈ 严重安全漏洞：SQL 注入</strong><br>
                        直接拼接用户输入到 SQL 语句<br>
                        攻击示例: ?order_by=id;DROP TABLE raw_entries;--<br>
                        修复方案: 使用白名单验证 order_by 字段
                    </div>
                </div>
            </div>

            <!-- Segmenter Section -->
            <div id="segmenter" class="section">
                <h2 class="section-title">Japanese Segmenter</h2>
                <p class="text-slate-warm mb-6 font-serif">基于规则的日语分词引擎 — 贪心算法与动词活用生成</p>
                
                <div class="code-block rounded-xl p-6 mb-6">
                    <div class="code-line">
                        <span class="line-number">09</span>
                        <span>    PUNCTUATIONS = {<span class="string">'。'</span>, <span class="string">'、'</span>, <span class="string">'？'</span>, ...}  <span class="comment"># 标点符号集</span></span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">16</span>
                        <span>    PARTICLES = {<span class="string">'は'</span>, <span class="string">'が'</span>, <span class="string">'を'</span>, ...}  <span class="comment"># 助词集</span></span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-vermilion">◉</strong> set 类型实现 O(1) 查找<br>
                        手工整理的日语语法词典
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">71</span>
                        <span>        <span class="keyword">while</span> remaining_text:</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">79</span>
                        <span>            word, word_type, word_hira, consumed = <span class="self">self</span>._match_word(...)</span>
                    </div>
                    
                    <div class="annotation success">
                        <strong class="text-jade">◆</strong> 贪心算法主循环<br>
                        从左到右逐个匹配单词，_match_word() 实现最大匹配
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">295-422</span>
                        <span>    <span class="comment"># 一类动词（五段）词尾变化表</span></span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">297</span>
                        <span>            <span class="string">'dictionary'</span>: (<span class="string">'う'</span>, <span class="string">'う'</span>),</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">298</span>
                        <span>            <span class="string">'masu'</span>: (<span class="string">'います'</span>, <span class="string">'います'</span>),</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">299</span>
                        <span>            <span class="string">'te'</span>: (<span class="string">'って'</span>, <span class="string">'って'</span>),</span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-gold">◈</strong> 五段动词活用规则<br>
                        う段: う→います、う→って（促音变）<br>
                        く段: く→きます、く→いて（い音变）<br>
                        12种活用形式完整实现
                    </div>
                </div>
            </div>

            <!-- Practice Section -->
            <div id="practice" class="section">
                <h2 class="section-title">Practice Algorithm</h2>
                <p class="text-slate-warm mb-6 font-serif">间隔重复算法 — 艾宾浩斯遗忘曲线的智能选题策略</p>
                
                <div class="code-block rounded-xl p-6 mb-6">
                    <div class="code-line">
                        <span class="line-number">22</span>
                        <span>        <span class="comment"># 1. 获取最近7天的句子（新知识，40%）</span></span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">25</span>
                        <span><span class="string">            WHERE created_at &gt;= datetime('now', '-7 days')</span></span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-vermilion">◉</strong> datetime('now', '-7 days') SQLite 日期函数<br>
                        查询最近7天录入的内容作为新知识
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">52</span>
                        <span>        new_count = <span class="class-name">int</span>(count * <span class="number">0.4</span>)</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">53</span>
                        <span>        medium_count = <span class="class-name">int</span>(count * <span class="number">0.3</span>)</span>
                    </div>
                    <div class="code-line">
                        <span class="line-number">54</span>
                        <span>        old_count = <span class="class-name">int</span>(count * <span class="number">0.2</span>)</span>
                    </div>
                    
                    <div class="annotation success">
                        <strong class="text-jade">◆</strong> 权重分配 40/30/20/10<br>
                        新内容40% + 近期30% + 旧知识20% + 随机10%
                    </div>

                    <div class="code-line mt-4">
                        <span class="line-number">86</span>
                        <span>        random.shuffle(questions)  <span class="comment"># 打乱顺序</span></span>
                    </div>
                    
                    <div class="annotation">
                        <strong class="text-gold">◈</strong> 随机化增加练习不可预测性<br>
                        避免同一天的内容集中出现
                    </div>
                </div>
            </div>

    <!-- Data Flow Section -->
            <div id="dataflow" class="section">
                <h2 class="section-title">Data Flow</h2>
                <div class="stat-card rounded-xl p-8">
                    <div class="mermaid">
sequenceDiagram
    actor User as 用户
    participant Frontend as 前端页面
    participant API as Flask API
    participant Service as Service层
    participant DB as SQLite

    Note over User,DB: 1. 录入数据流程
    User->>Frontend: 粘贴JSON数据
    Frontend->>API: POST /api/entries/preview
    API->>Service: JapaneseSegmenter.segment()
    Service-->>API: 分词结果
    API-->>Frontend: 预览数据
    User->>Frontend: 确认入库
    Frontend->>API: POST /api/entries/{id}/confirm
    API->>DB: INSERT raw_entries
    API->>DB: INSERT segmented_words
    API->>DB: INSERT verb_conjugations
    API->>DB: INSERT phonetic_index
    API-->>Frontend: 入库成功
                    </div>
                </div>
            </div>

            <!-- API Call Chain Section -->
            <div id="api" class="section">
                <h2 class="section-title">API Call Chain</h2>
                <p class="text-slate-warm mb-6 font-serif">前后端 API 调用链路示意</p>
                <div class="stat-card rounded-xl p-8">
                    <div class="mermaid">
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端页面
    participant API as Flask API
    participant Service as Service层
    participant DB as SQLite

    Note over User, Frontend: 数据提交流程
    User->>Frontend: 粘贴 JSON/请求
    Frontend->>API: POST /api/entries/preview
    API->>Service: JapaneseSegmenter.segment()
    Service-->>API: 预览数据/分词结果
    API-->>Frontend: 预览结果
    Frontend->>API: POST /api/entries/{id}/confirm
    API->>DB: INSERT raw_entries
    API->>DB: INSERT segmented_words
    API-->>Frontend: 入库成功
                    </div>
                </div>
            </div>

            <!-- ERD Section -->
            <div id="erd" class="section">
                <h2 class="section-title">Database ERD</h2>
                <div class="stat-card rounded-xl p-8">
                    <div class="mermaid">
erDiagram
    RAW_ENTRIES ||--o{ SEGMENTED_WORDS : contains
    RAW_ENTRIES ||--o{ PHONETIC_INDEX : indexed_by
    SEGMENTED_WORDS }o--|| VERB_MASTER : references
    VERB_MASTER ||--o{ VERB_CONJUGATIONS : has
    
    RAW_ENTRIES {
        int id PK
        string content_type
        string original_jp
        string hiragana
        string chinese_meaning
        boolean processed
        timestamp created_at
    }
    
    SEGMENTED_WORDS {
        int id PK
        int raw_entry_id FK
        string word_jp
        string word_type
        json grammar_info
    }
    
    VERB_MASTER {
        int id PK
        string prototype
        string verb_class
    }
    
    VERB_CONJUGATIONS {
        int id PK
        int verb_id FK
        string form_type
        string form_value
    }
    
    PHONETIC_INDEX {
        int id PK
        string phonetic
        int entry_id
    }
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Mermaid initialization
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#dc2626',
                primaryTextColor: '#fff',
                primaryBorderColor: '#dc2626',
                lineColor: '#64748b',
                secondaryColor: '#1e1b4b',
                tertiaryColor: '#0a0a0c',
                fontFamily: 'JetBrains Mono'
            },
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            erDiagram: {
                useMaxWidth: true,
                htmlLabels: true
            },
            sequence: {
                useMaxWidth: true,
                wrap: true
            }
        });

        // Initialize all mermaid diagrams on page load
        async function initMermaid() {
            try {
                await mermaid.run({
                    querySelector: '.mermaid'
                });
            } catch (e) {
                console.log('Mermaid init error:', e);
            }
        }

        // Navigation
        function showSection(sectionId, btn) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            const el = document.getElementById(sectionId);
            if (el) el.classList.add('active');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            if (btn) btn.classList.add('active');
            // Re-render Mermaid diagrams inside the activated section
            setTimeout(() => {
                try {
                    mermaid.run({
                        querySelector: '.mermaid'
                    });
                } catch (e) { /* ignore */ }
            }, 100);
        }

        // Self-test functions
        function setTestStatus(status, message){
            var badge = document.getElementById('test-status');
            if (!badge) return;
            badge.textContent = 'Test: ' + status + (message ? ' - ' + message : '');
            badge.classList.remove('test-pass', 'test-fail');
            if (status === 'PASS') badge.classList.add('test-pass');
            if (status === 'FAIL') badge.classList.add('test-fail');
        }

        function runTests(){
            var pass = true;
            var messages = [];
            var sections = document.querySelectorAll('.section');
            if (!sections || sections.length === 0){ pass = false; messages.push('missing sections'); }
            var navItems = document.querySelectorAll('.nav-item');
            if (!navItems || navItems.length < 1){ pass = false; messages.push('missing nav items'); }
            var codeBlocks = document.querySelectorAll('.code-block');
            if (!codeBlocks || codeBlocks.length < 1){ pass = false; messages.push('missing code blocks'); }
            if (pass){ setTestStatus('PASS', messages.join('; ')); }
            else { setTestStatus('FAIL', messages.join('; ')); }
        }

        // Initialize on page load
        window.addEventListener('DOMContentLoaded', function() {
            initMermaid();
            runTests();
        });
    </script>
</body>
</html>
